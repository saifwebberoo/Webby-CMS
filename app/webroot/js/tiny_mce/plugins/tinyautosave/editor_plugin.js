/*
	TinyAutoSave 2.1 (November 19, 2009) plugin for TinyMCE
	http://tinyautosave.googlecode.com/
	Copyright (c) 2008-2009 Todd Northrop
	http://www.speednet.biz/
	Licensed under GPL 3, see  <http://www.gnu.org/licenses/>
*/
(function(){var q="function",f="string",d=true,p="OK",r="TinyAutoSave",b=null,a=false,L="2.1",c="tinyautosave",h=a,m=a,k=a,D={"%":"%1","&":"%2",";":"%3","=":"%4","<":"%5"},C={"%1":"%","%2":"&","%3":";","%4":"=","%5":"<"},s=[],n={},t={},l="TinyAutoSave_Test_",g=b,o={dataKey:r,cookieFilter:b,saveDelegate:b,saveFinalDelegate:b,restoreDelegate:b,disposeDelegate:b,restoreImage:"",progressImage:"progress.gif",intervalSeconds:60,retentionMinutes:20,minSaveLength:50,canRestore:a,busy:a,timer:b};try{localStorage.setItem(l,p);if(localStorage.getItem(l)===p){localStorage.removeItem(l);h=d}}catch(z){try{sessionStorage.setItem(l,p);if(sessionStorage.getItem(l)===p){sessionStorage.removeItem(l);m=d}}catch(z){k=tinymce.isIE}}tinymce.PluginManager.requireLangPack(c);tinymce.create("tinymce.plugins.TinyAutoSavePlugin",{editor:b,url:"",key:"",onPreSave:b,onPostSave:b,onSaveError:b,onPreRestore:b,onPostRestore:b,onRestoreError:b,showSaveProgress:d,progressDisplayTime:1200,init:function(d,l){var h="mceTinyAutoSaveRestore",e=this,n=tinymce.is,p=tinymce.resolve,a,j,m;if(k){if(!g)g=d.getElement();g.style.behavior="url('#default#userData')"}e.editor=d;e.id=d.id;e.url=l;e.key=d.getParam(c+"_key",d.id);a=B(e);a.restoreImage=l+"/images/restore."+(tinymce.isIE6?"gif":"png");e.setProgressImage(l+"/images/"+o.progressImage);a.intervalSeconds=Math.max(1,parseInt(d.getParam(c+"_interval_seconds",b)||d.getParam(c+"_interval",a.intervalSeconds)));a.retentionMinutes=Math.max(1,parseInt(d.getParam(c+"_retention_minutes",b)||d.getParam(c+"_retention",a.retentionMinutes)));a.minSaveLength=Math.max(1,parseInt(d.getParam(c+"_minlength",a.minSaveLength)));e.showSaveProgress=d.getParam(c+"_showsaveprogress",e.showSaveProgress);a.canRestore=e.hasSavedContent();a.saveDelegate=i(e,y);a.saveFinalDelegate=i(e,w);a.restoreDelegate=i(e,x);d.addCommand("mceTinyAutoSave",a.saveDelegate);d.addCommand(h,a.restoreDelegate);d.addButton(c,{title:c+".restore_content",cmd:h,image:a.restoreImage});a.timer=window.setInterval(a.saveDelegate,a.intervalSeconds*1e3);tinymce.dom.Event.add(window,"unload",a.saveFinalDelegate);d.onRemove.add(a.saveFinalDelegate);d.onPostRender.add(function(b){b.controlManager.setDisabled(c,!a.canRestore)});j=d.getParam(c+"_oninit",b);if(n(j,f)){m=p(j);n(m,q)&&m.apply(e)}},getInfo:function(){return {longname:r,author:"Speednet",authorurl:"http://www.speednet.biz/",infourl:"http://tinyautosave.googlecode.com/",version:L}},clear:function(){var d=this,f=d.editor,b=e(d);if(h)localStorage.removeItem(b.dataKey);else if(m)sessionStorage.removeItem(b.dataKey);else if(k)E(d);else tinymce.util.Cookie.remove(b.dataKey);b.canRestore=a;f.controlManager.setDisabled(c,d)},hasSavedContent:function(){var g=this,b=e(g),i=new Date,c,f;try{if(h||m){c=((h?localStorage.getItem(b.dataKey):sessionStorage.getItem(b.dataKey))||"").toString(),f=c.indexOf(",");if(f>8&&f<c.length-1){if(new Date(c.slice(0,f))>i)return d;if(h)localStorage.removeItem(b.dataKey);else sessionStorage.removeItem(b.dataKey)}return a}else if(k)return (v(g)||"").length>0;return (tinymce.util.Cookie.get(b.dataKey)||"").length>0}catch(j){return a}},setProgressImage:function(a){tinymce.is(a,f)&&I(e(this).progressImage=a)}});function K(){var b=this,a=e(b);a.timer&&window.clearInterval(a.timer);tinymce.dom.Event.remove(window,"unload",a.saveFinalDelegate);b.editor.onRemove.remove(a.saveFinalDelegate);A(b)}function j(a){if(!a)return d;var c,b,e=tinymce.is;if(e(a,f)){c=t[a];if(c)b=c[a];else t[a]=b=tinymce.resolve(a)}else if(e(a,q))b=a;else return d;return b.apply(this)}function w(){var a=e(this);a.saveDelegate();a.disposeDelegate()}function y(){var g=this,q=g.editor,b=e(g),v=tinymce.is,o=a,t=new Date,i,n,r,l,p,s;if(q&&!b.busy){b.busy=d;i=q.getContent();if(v(i,f)&&i.length>=b.minSaveLength){if(!j.call(g,g.onPreSave)){b.busy=a;return a}n=new Date(t.getTime()+b.retentionMinutes*60*1e3);try{if(h)localStorage.setItem(b.dataKey,n.toString()+","+u(i));else if(m)sessionStorage.setItem(b.dataKey,n.toString()+","+u(i));else if(k)J(g,i,n);else{r=b.dataKey+"=";l="; expires="+n.toUTCString();document.cookie=r+H(i).slice(0,4096-r.length-l.length)+l}o=d}catch(w){j.call(g,g.onSaveError)}if(o){p=q.controlManager;b.canRestore=d;p.setDisabled(c,a);if(g.showSaveProgress){l=tinymce.DOM.get(p.get(c).id);s=b.restoreImage;l.firstChild.src=b.progressImage;window.setTimeout(function(){l.firstChild.src=s},Math.min(g.progressDisplayTime,b.intervalSeconds*1e3-100))}j.call(g,g.onPostSave)}}b.busy=a}return o}function x(){var g=this,n=g.editor,l=e(g),i=b,q=tinymce.is,o,p;if(n&&l.canRestore&&!l.busy){l.busy=d;if(!j.call(g,g.onPreRestore)){l.busy=a;return}try{if(h||m){i=((h?localStorage.getItem(l.dataKey):sessionStorage.getItem(l.dataKey))||"").toString();o=i.indexOf(",");if(o==-1)i=b;else i=F(i.slice(o+1,i.length))}else if(k)i=v(g);else{p=l.cookieFilter.exec(document.cookie);if(p)i=G(p[1])}if(!q(i,f))n.windowManager.alert(c+".no_content");else if(n.getContent().replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length===0){n.setContent(i);j.call(g,g.onPostRestore)}else n.windowManager.confirm(c+".warning_message",function(b){if(b){n.setContent(i);j.call(g,g.onPostRestore)}l.busy=a},g)}catch(r){j.call(g,g.onRestoreError)}l.busy=a}}function J(a,c,b){g.setAttribute(e(a).dataKey,c);g.expires=b.toUTCString();g.save("TinyMCE")}function v(a){g.load("TinyMCE");return g.getAttribute(e(a).dataKey)}function E(a){g.removeAttribute(e(a).dataKey)}function H(a){return a.replace(/[\x00-\x1f]+|&nbsp;|&#160;/gi," ").replace(/(.)\1{5,}|[%&;=<]/g,function(a){if(a.length>1)return "%0"+a.charAt(0)+a.length.toString()+"%";return D[a]})}function G(a){return a.replace(/%[1-5]|%0(.)(\d+)%/g,function(c,f,e){var a,b,d;if(c.length==2)return C[c];for(a=[],b=0,d=parseInt(e);b<d;b++)a.push(f);return a.join("")})}function u(a){return a.replace(/,/g,"&#44;")}function F(a){return a.replace(/&#44;/g,",")}function I(b){var a=s.length;s[a]=new Image;s[a].src=b}function i(b,a){return function(){return a.apply(b)}}function B(a){var b=a.key,c=n[b];if(!c)c=n[b]=tinymce.extend({},o,{dataKey:o.dataKey+b,saveDelegate:i(a,y),saveFinalDelegate:i(a,w),restoreDelegate:i(a,x),disposeDelegate:i(a,K),cookieFilter:new RegExp("(?:^|;\\s*)"+o.dataKey+b+"=([^;]*)(?:;|$)","i")});return c}function e(a){return n[a.key]}function A(a){delete n[a.key]}tinymce.PluginManager.add(c,tinymce.plugins.TinyAutoSavePlugin)})();